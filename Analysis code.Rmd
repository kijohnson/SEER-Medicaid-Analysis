---
title: "SEER Medicaid"
author: "Kim Johnson"
date: '2022-06-06'
output: html_document
---
# What this analysis will do from project description
1.	Is there an association between cancer stage at diagnosis and survival and insurance status at diagnosis in children (0 to 14 years) and adolescents and young adults (15-39 years) overall and stratified by five-year age groups?

Hypothesis: We hypothesize that those with Medicaid will have an increased risk of death and later-stage diagnosis compared to those with private insurance and that this association will become progressively stronger with increasing age. 

2.	Determine whether sociodemographic and economic factors modify associations.

Hypothesis: We hypothesize that certain sociodemographic and economic factors (e.g. race/ethnicity, rural/urban status, census tract SES measures) modify associations between insurance and stage at diagnosis and survival. 

3.	Determine whether associations between stage at diagnosis and survival differ by the timing of Medicaid enrollment with the following categories: 
o	before diagnosis defined as those who enrolled before the year of diagnosis, 
o	around diagnosis defined as in the year of diagnosis 
o	after diagnosis defined as in the year after diagnosis
o	Not enrolled (did not link to Medicaid)*

Hypothesis: We hypothesize that those enrolled in Medicaid around diagnosis or after diagnosis will have later stage diagnoses and a greater hazard of death than those enrolled before diagnosis.

# Further notes on timing of enrollment
1. They considered them enrolled in Medicaid within a 25 month window so not just the flag for Medicaid (I think there was refinement after that to limit it to 25 months)
2. Those that were enrolled in Medicaid in more than one state during that 25 month window were excluded and also those with a match score of <5.
3. Then in that group, it appears that they probably made the following variable or variables:
Enrolled any month before the diagnosis month but not during the dx month==enrolled before dx
Enrolled in the month of dx  == enrolled at dx
 
Those enrolled before and after were classified as enrolled before dx.
 
So this does not get at churning (yet) but I think may be more straightforward than what I was thinking. I would hypothesize that the first bulleted group has better survival than the second.
# Open libraries
```{r}
pacman::p_load(readr, dplyr, tidyverse, lubridate, survival, survminer, hablar)
```

# Import files and get data into right columns, assign column names
```{r, eval =FALSE}
# # Medicaid enrollment--imports fixed width columns and gives them names
# enroll <- read_fwf('medicaid.enroll.txt', 
#                fwf_cols(patient_id = 15, STATE_CD = 2, YEAR = 4, DOB_MATCH_SCORE_HI = 1, SEX_MATCH_SCORE_HI = 1,
#                        ID_MATCH_SCORE_HI=1, MATCH_SCORE_HI=2, MEDICAID_ELIG_CD1=1, MEDICAID_ELIG_CD2=1,
#                       MEDICAID_ELIG_CD3=1, MEDICAID_ELIG_CD4=1, MEDICAID_ELIG_CD5=1, MEDICAID_ELIG_CD6=1,
#                       MEDICAID_ELIG_CD7=1, MEDICAID_ELIG_CD8=1, MEDICAID_ELIG_CD9=1, MEDICAID_ELIG_CD10=1,
#                         MEDICAID_ELIG_CD11=1, MEDICAID_ELIG_CD12=1), 
#                skip = 0)

# # SEER file 
# 
# seer<-read_fwf('medicaid.cancer 2.txt', na=".", fwf_positions(
# c(1, 16,18,20,21,22,24,25,28,31,33,35,39,41,45,46,50,51,55,56,57,58,59,62,64,66,67,69, 71, 72,73,74,75,76,77,78,79,80,81,82,83,84,86,88,90,92,94,95,96,97,98,99,100,103,106,109, 111,114,117,120,123,126,129,132,135,138,141,144,147,150,153,156, 159,161,163,165,167,168,174,180,186,188,189,190,192,193,194,195,196,197,199, 200,201,203,205,210,213,216,217,219,224,227,228,229,230,231,233,235,236,238,241,242, 243,248, 253, 254, 255,256, 258,263,264,265,266,267,268,269,270,271,273,279,282,285,288,291,293,295,297,299, 300,301,302,303,304,305,306,308,310,316,347,353,359,365,366,367,368,369,378,380,382,384,388,401,402,403,404,405, 406,408,412,414, 419, 423,425,427,429, 431,433,437,438,439,440,441,442,443,445, 447, 448, 452, 456, 460, 464,465,466,467,468,469,470, 471,472,473,474,475,476,477, 479, 480,485,490,495,500,505, 510,511,512,513,514,515,519,520, 521,524,525,526,530,532), 
#   
# c(15,17,19,20,21,23,24,27,30,32,34,38,40,44,45,49,50,54,55,56,57,58,61,63,65,66,68,70,71, 72,73,74,75,76,77,78,79,80,81,82,83,84,86,88,90,93,94,95,96,97,98, 99,102,105,108,110,113,116,119,122,125,128,131,134,137, 140, 143,146,149,152,155,158,160,162,164,166,167,173,179, 185,187,188,189,191, 192,193,194,195,195, 198,199, 200,202,204,209,212,215,216,218,220, 226,227,228,229,230,232,234,235,237,240,241,242,247, 252, 253, 254,255,257, 259, 263,264,265,266,267,268,269,270, 272,273,281,284,287,290,292,294,295,298,299, 300, 301,302,303,304,305,307, 309,311,316,352,358, 364,365,366,367,368,369, 379,381,383,387,391,401,402,403,404,405, 407,411,413,417, 422,424,426,428,430, 432,436,437,438,439,440,441,442,444,446, 447, 451, 455,459,463,464, 465, 466,467,468,469,470, 471,472,473,474,475,476,477,479, 484,489,494,499,504,509,510,511,512,513,514,515,519,520, 523,524,525,529,531,534)))
# 
# colnames(seer)<- c("patient_id", "SEER_registry", "SEERregistrywithCAandGAaswholes", 
# "Louisiana20051stvs2ndhalfofyear", "Marital_status_at_diagnosis", 
# "Race_ethnicity", "sex", "Agerecodewithsingleages_and_100", "agerecodewithsingle_ages_and_85", 
# "Sequence_number", "Month_of_diagnosis", "Year_of_diagnosis", 
# "Month_of_diagnosis_recode", "Primary_Site", "Laterality", "Histology_ICD_O_2", 
# "Behavior_code_ICD_O_2", "Histologic_Type_ICD_O_3", "Behavior_code_ICD_O_3", 
# "Grade", "Diagnostic_Confirmation", "Type_of_Reporting_Source", 
# "EOD_10_size_1988_2003", "EOD_10_extent_1988_2003", "EOD10Prostatepath_ext_1995_2003", 
# "EOD_10_nodes_1988_2003", "Regional_nodes_positive_1988", "Regional_nodes_examined_1988", 
# "Expanded_EOD_1_CP53_1973_1982", "Expanded_EOD_2_CP54_1973_1982", 
# "Expanded_EOD_3_CP55_1973_1982", "Expanded_EOD_4_CP56_1973_1982", 
# "Expanded_EOD_5_CP57_1973_1982", "Expanded_EOD_6_CP58_1973_1982", 
# "Expanded_EOD_7_CP59_1973_1982", "Expanded_EOD_8_CP60_1973_1982",
# "Expanded_EOD_9_CP61_1973_1982", "Expanded_EOD_10_CP62_1973_1982",
# "Expanded_EOD_11_CP63_1973_1982", "Expanded_EOD_12_CP64_1973_1982",
# "Expanded_EOD_13_CP65_1973_1982", "V2Digit_NS_EOD_part_1_1973_1982",
# "V2Digit_NS_EOD_part_2_1973_1982", "V2Digit_SS_EOD_part_1_1973_1982",
# "V2Digit_SS_EOD_part_2_1973_1982", "EOD_4_size_1983_1987", "EOD_4_extent_1983_1987",
# "EOD_4_nodes_1983_1987", "Coding_system_EOD_1973_2003", "Tumor_marker_1_1990_2003",
# "Tumor_marker_2_1990_2003", "Tumor_marker_3_1998_2003", "CS_tumor_size_2004_2015",
# "CS_extension_2004_2015", "CS_lymph_nodes_2004_2015", "CS_mets_at_dx_2004_2015",
# "CSsitespecificfactor12004varyin", "CSsitespecificfactor22004varyin",
# "CSsitespecificfactor32004varyin", "CSsitespecificfactor42004varyin",
# "CSsitespecificfactor52004varyin", "CSsitespecificfactor62004varyin",
# "CSsitespecificfactor72004varyin", "CSsitespecificfactor82004varyin",
# "CSsitespecificfactor92004varyin", "CSsitespecificfactor102004varyi",
# "CSsitespecificfactor112004varyi", "CSsitespecificfactor122004varyi",
# "CSsitespecificfactor132004varyi", "CSsitespecificfactor152004varyi",
# "CSsitespecificfactor162004varyi", "CSsitespecificfactor252004varyi",
# "Derived_AJCC_T_6th_ed_2004_2015", "Derived_AJCC_N_6th_ed_2004_2015",
# "Derived_AJCC_M_6th_ed_2004_2015", "DerivedAJCCStageGroup6thed20042",
# "SEERCombinedSummaryStage2000200", "CSversioninputoriginal2004_2015",
# "CS_version_derived_2004_2015", "CSversioninputcurrent_2004_2015",
# "RX_Summ_Surg_Prim_Site_1998", "RX_Summ_Scope_Reg_LN_Sur_2003",
# "RX_Summ_Surg_Oth_Reg_Dis_2003", "RXSummReg_LN_Examined_1998_2002",
# "RX_Summ_Systemic_Surg_Seq", "RX_Summ_Surg_Rad_Seq", "Reasonnocancer_directed_surgery",
# "Radiation_recode", "Chemotherapy_recode_yes_no_unk", "Sitespecificsurgery19731997vary",
# "Scopeofreglymphndsurg_1998_2002", "Surgeryofothregdissites19982002",
# "Record_number_recode", "Age_recode_with_1_year_olds", "Site_recode_ICD_O_3_WHO_2008",
# "ICCCsiterecode_ICD_O_3_WHO_2008", "ICCCsiterecextendedICDO3WHO2008",
# "Behavior_recode_for_analysis", "Histologyrecode_broad_groupings",
# "Histologyrecode_Brain_groupings", "TNM_7_CS_v0204_Schema", "Race_recode_White_Black_Other",
# "Race_recode_W_B_AI_API", "OriginrecodeNHIAHispanicNonHisp",
# "SEER_historic_stage_A_1973_2015", "AJCCstage_3rd_edition_1988_2003",
# "SEERmodifiedAJCCstage3rd1988200", "Firstmalignantprimary_indicator",
# "state", "county", "PRCDA_2017", "PRCDA_Region", "COD_to_site_recode",
# "COD_to_site_rec_KM", "Vitalstatusrecodestudycutoffuse", "IHS_Link",
# "Summary_stage_2000_1998", "AYA_site_recode_WHO_2008", "Lymphomasubtype_recode_WHO_2008",
# "SEERcausespecificdeathclassific", "SEERothercauseofdeathclassifica",
# "CSTumor_Size_Ext_Eval_2004_2015", "CS_Reg_Node_Eval_2004_2015",
# "CS_Mets_Eval_2004_2015", "Primary_by_international_rules", "ERStatusRecodeBreastCancer_1990",
# "PRStatusRecodeBreastCancer_1990", "CS_Schema_AJCC_6th_Edition",
# "LymphvascularInvasion2004varyin", "Derived_AJCC_T_7th_ed_2010",
# "Derived_AJCC_N_7th_ed_2010", "Derived_AJCC_M_7th_ed_2010", "DerivedAJCCStageGroup7thed_2010",
# "BreastAdjustedAJCC6thT1988_2015", "BreastAdjustedAJCC6thN1988_2015",
# "BreastAdjustedAJCC6thM1988_2015", "BreastAdjustedAJCC6thStage19882",
# "Derived_HER2_Recode_2010", "Breast_Subtype_2010", "LymphomaAnnArborStage_1983_2015",
# "SEERCombinedMetsat_DX_bone_2010", "SEERCombinedMetsatDX_brain_2010",
# "SEERCombinedMetsatDX_liver_2010", "SEERCombinedMetsat_DX_lung_2010",
# "TvaluebasedonAJCC_3rd_1988_2003", "NvaluebasedonAJCC_3rd_1988_2003",
# "MvaluebasedonAJCC_3rd_1988_2003", "RadiationtoBrainorCNSRecode1988",
# "Census_Tract_1990", "Census_Tract_2000", "Census_Tract_2010",
# "Census_Coding_System", "Census_Tract_Certainty_1990", "Census_Tract_Certainty_2000",
# "Census_Tract_Certainty_2010", "Census_Tract_Poverty_Indicator",
# "Rural_Urban_Continuum_Code_1993", "Rural_Urban_Continuum_Code_2003",
# "Rural_Urban_Continuum_Code_2013", "Health_Service_Area", "HealthService_Area_NCI_Modified",
# "Derived_SS1977_flag", "Derived_SS2000_flag", "Firstcourseofreconstruct1998200",
# "Radiation", "RadiationtoBrainorCNS_1988_1997", "SEER_DateofDeath_Month",
# "SEER_DateofDeath_Year", "Month_of_last_follow_up_recode", "Year_of_last_follow_up_recode",
# "Year_of_birth", "Date_of_diagnosis_flag", "Date_therapy_started_flag",
# "Date_of_birth_flag", "Date_of_last_follow_up_flag", "Month_therapy_started",
# "Year_therapy_started", "Other_cancer_directed_therapy", "Derived_AJCC_flag",
# "Derived_SS1977", "Derived_SS2000", "SEER_Summary_stage_1977_9500",
# "SEER_Summary_stage_2000_0103", "NAPIIA_Derived_API_Race", "Primary_Payer_at_DX",
# "COD_ICD_code", "Cause_of_Death_ICD_8_or_9", "Cause_of_Death_ICD_10",
# "Recode_ICD_0_2_to_9", "Recode_ICD_0_2_to_10", "NHIA_Derived_Hisp_Origin",
# "Age_site_edit_override", "Sequencenumber_dx_conf_override",
# "Site_type_lat_seq_override", "Surgerydiagnostic_conf_override",
# "Site_type_edit_override", "Histology_edit_override", "Report_source_sequence_override",
# "Seq_ill_defined_site_override", "LeukLymphdxconfirmationoverride",
# "Site_behavior_override", "Site_EOD_dx_date_override", "Site_laterality_EOD_override",
# "Site_laterality_morph_override", "Insurance_Recode_2007", "Yost_ACS_2006_2010",
# "Yost_ACS_2010_2014", "Yost_ACS_2013_2017", "Yost_ACS_2006_2010_State_based",
# "Yost_ACS_2010_2014_State_based", "Yost_ACS_2013_2017_State_based",
# "Yost_ACS_2006_2010_quintile", "Yost_ACS_2010_2014_quintile",
# "Yost_ACS_2013_2017_quintile", "YostACS20062010quintileStatebas",
# "YostACS20102014quintileStatebas", "YostACS20132017quintileStatebas",
# "HPV_recode_2010", "In_Medicaid_Flag", "OncotypeDXBreastRecurrenceScore",
# "OncotypeDXRSgroupRS18RS1830RS30", "OncotypeDXreasonno_score_linked",
# "Oncotype_DX_year_of_test_report", "OncotypeDX_month_of_test_report",
# "OncotypeDXmonthssince_diagnosis")

# hit control shift c while highlighting above to uncomment/comment section
```

# Data management 
# Exclude those over 39 years old and export data to make the datasets more manageeable on import
```{r}
# exclude from seer first
# seer_0to39<-seer %>%
#   filter(Agerecodewithsingleages_and_100<40)
# 
# get ids to limit enrollment file
# 
# ids<-seer_0to39$patient_id

# enroll_seerids<-enroll %>%
 # filter(patient_id %in% ids)

```
# export these data as csv files for quicker import
```{r}
# write.csv(seer_0to39,"seer0to39.csv", row.names = FALSE)
# 
# write.csv(enroll_seerids,"enroll_seerids.csv", row.names = FALSE)
```

# Import files created with text commented out above for analysis
```{r}
seer0to39<-read_csv("seer0to39.csv")
enroll_seerids<-read_csv("enroll_seerids.csv")
mcseer <- read_csv("/Volumes/kijohnson/Active/mcseer_dsb/mcseer_dsb.csv") # Derek's file that contains continuity of enrollment variables
```

# Identify ids to exclude where patient has files in multiple states
```{r}
 df<-enroll_seerids %>% 
   find_duplicates(patient_id, YEAR)
 
x <- unique(df$patient_id) # 841 vector of unique ids to exclude
```

# Reduce dataset to variables needed for analysis
```{r}
# select variables
seer0to39<-seer0to39 %>%
  select("patient_id", "SEER_registry", "Race_ethnicity", "sex", "Agerecodewithsingleages_and_100",
"Sequence_number", "Month_of_diagnosis", "Year_of_diagnosis",
"Month_of_diagnosis_recode", "Primary_Site", "Laterality", "Histology_ICD_O_2",
"Behavior_code_ICD_O_2", "Histologic_Type_ICD_O_3", "Behavior_code_ICD_O_3",
"Grade", "Diagnostic_Confirmation", "Type_of_Reporting_Source", "Derived_AJCC_T_6th_ed_2004_2015", "Derived_AJCC_N_6th_ed_2004_2015","Derived_AJCC_M_6th_ed_2004_2015", "DerivedAJCCStageGroup6thed20042",
"SEERCombinedSummaryStage2000200", "Age_recode_with_1_year_olds", "Site_recode_ICD_O_3_WHO_2008",
"ICCCsiterecode_ICD_O_3_WHO_2008", "ICCCsiterecextendedICDO3WHO2008",
"Behavior_recode_for_analysis", "Histologyrecode_broad_groupings", "Race_recode_White_Black_Other",
"Race_recode_W_B_AI_API", "OriginrecodeNHIAHispanicNonHisp",
"SEER_historic_stage_A_1973_2015", "AJCCstage_3rd_edition_1988_2003",
"SEERmodifiedAJCCstage3rd1988200", "Firstmalignantprimary_indicator",
"state", "county", "PRCDA_2017", "PRCDA_Region", "COD_to_site_recode",
"COD_to_site_rec_KM", "Vitalstatusrecodestudycutoffuse", "IHS_Link",
"Summary_stage_2000_1998", "SEERCombinedSummaryStage2000200", "AYA_site_recode_WHO_2008", 
"SEERcausespecificdeathclassific", "SEERothercauseofdeathclassifica",
"Derived_AJCC_T_7th_ed_2010", "Derived_AJCC_N_7th_ed_2010", "Derived_AJCC_M_7th_ed_2010", "DerivedAJCCStageGroup7thed_2010", "Census_Tract_1990", "Census_Tract_2000", "Census_Tract_2010",
"Census_Coding_System", "Census_Tract_Certainty_1990", "Census_Tract_Certainty_2000",
"Census_Tract_Certainty_2010", "Census_Tract_Poverty_Indicator",
"Rural_Urban_Continuum_Code_1993", "Rural_Urban_Continuum_Code_2003",
"Rural_Urban_Continuum_Code_2013", "Health_Service_Area", "HealthService_Area_NCI_Modified",
"SEER_DateofDeath_Month", "SEER_DateofDeath_Year", "Month_of_last_follow_up_recode", "Year_of_last_follow_up_recode", "Year_of_birth", "Date_of_diagnosis_flag", "Date_therapy_started_flag",
"Date_of_birth_flag", "Date_of_last_follow_up_flag", "Month_therapy_started",
"Year_therapy_started",  "Derived_AJCC_flag","SEER_Summary_stage_1977_9500",
"SEER_Summary_stage_2000_0103", "NAPIIA_Derived_API_Race", "Primary_Payer_at_DX",
"COD_ICD_code", "Cause_of_Death_ICD_8_or_9", "Cause_of_Death_ICD_10",
"Recode_ICD_0_2_to_9", "Recode_ICD_0_2_to_10", "NHIA_Derived_Hisp_Origin",
"Insurance_Recode_2007", "Yost_ACS_2006_2010", "Yost_ACS_2010_2014", "Yost_ACS_2013_2017", "Yost_ACS_2006_2010_State_based", "Yost_ACS_2010_2014_State_based", "Yost_ACS_2013_2017_State_based",
"Yost_ACS_2006_2010_quintile", "Yost_ACS_2010_2014_quintile",
"Yost_ACS_2013_2017_quintile", "YostACS20062010quintileStatebas",
"YostACS20102014quintileStatebas", "YostACS20132017quintileStatebas",
"HPV_recode_2010", "In_Medicaid_Flag")
```

# Data management
```{r}
# tables for insurance prior to recoding
table(seer0to39$In_Medicaid_Flag)
table(seer0to39$Insurance_Recode_2007)

seer0to39$Primary_Payer_at_DX<-as.numeric(seer0to39$Primary_Payer_at_DX)
seer0to39<-seer0to39%>%
  mutate(insurance=if_else(In_Medicaid_Flag==1, 1, # ever had Medicaid betweeen 2006 to 2013
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX %in% c(20,21), 0, # private insurance
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX %in% c(1,2), 2, # uninsured
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX %in% c(31,35), 3, # misclassified with Medicaid
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX %in% c(60,61,62,63,64), 4, # Medicare
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX %in% c(65,66, 67), 5, # Military
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX == 68, 6, # Indian/Public Health service
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX == 99, 7, # unknown
                           if_else(In_Medicaid_Flag==0 & Primary_Payer_at_DX == 10, 8, NULL))))))))))  # insurance NOS

seer0to39$insurance<-factor(seer0to39$insurance, levels=c(0:8), labels=c("Private Insurance", "Medicaid", "Uninsured", "Misclassified as Medicaid", "Medicare", "Military", "Indian/Public Health Service", "Unknown", "insurance NOS"))

# Classification in SEER file
seer0to39<-seer0to39%>%
  mutate(insurance2=if_else(Primary_Payer_at_DX %in% c(20,21), 0, # private insurance
                           if_else(Primary_Payer_at_DX %in% c(1,2), 1, # uninsured
                           if_else(Primary_Payer_at_DX %in% c(31,35), 2, #  Medicaid
                           if_else(Primary_Payer_at_DX %in% c(60,61,62,63,64), 3, # Medicare
                           if_else(Primary_Payer_at_DX %in% c(65,66, 67), 4, # Military
                           if_else(Primary_Payer_at_DX == 68, 5, # Indian/Public Health service
                           if_else(Primary_Payer_at_DX == 99, 6, # unknown
                           if_else(Primary_Payer_at_DX == 10, 7, NULL)))))))))  # insurance NOS

seer0to39$insurance2<-factor(seer0to39$insurance2, levels=c(0:7), labels=c("Private Insurance", "Uninsured", "Medicaid", "Medicare", "Military", "Indian/Public Health Service", "Unknown", "insurance NOS"))

table(seer0to39$Primary_Payer_at_DX,seer0to39$insurance, useNA="always")
table(seer0to39$In_Medicaid_Flag, useNA="always")

test <- seer0to39 %>%
  filter(Primary_Payer_at_DX == 1)

class(seer0to39$Primary_Payer_at_DX)
 

# look at insurance at dx by Medicaid flag
table(seer0to39$Primary_Payer_at_DX, seer0to39$In_Medicaid_Flag)
table(seer0to39$Insurance_Recode_2007, seer0to39$In_Medicaid_Flag)
table(seer0to39$Primary_Payer_at_DX, seer0to39$In_Medicaid_Flag)
table(seer0to39$Primary_Payer_at_DX, seer0to39$Insurance_Recode_2007)

# recode demographic variables
# Age, race, hspanic, odeath, cause specfic death
table(seer0to39$Age_recode_with_1_year_olds)

seer0to39<-seer0to39 %>%
  mutate(age_cat=case_when(Age_recode_with_1_year_olds %in% c(0,1) ~ 0,
                                Age_recode_with_1_year_olds == 2 ~1,
                                Age_recode_with_1_year_olds == 3 ~2,
                                Age_recode_with_1_year_olds == 4 ~3,
                                Age_recode_with_1_year_olds %in% c(5,6,7,8) ~ 4))%>%
         
         mutate(race_cat=case_when(Race_recode_W_B_AI_API == 1 ~0,
                                Race_recode_W_B_AI_API == 2 ~1,
                                Race_recode_W_B_AI_API == 3 ~2,
                                Race_recode_W_B_AI_API == 4 ~3,
                                Race_recode_W_B_AI_API == 9 ~4)) %>%
  
        mutate(hispanic = case_when(OriginrecodeNHIAHispanicNonHisp == 0 ~0,
                                    OriginrecodeNHIAHispanicNonHisp == 1 ~1)) %>%
  
        mutate(race_ethnicity = case_when(race_cat == 0 & hispanic == 0 ~ 0,
                                race_cat == 1 & hispanic == 0 ~ 1,
                                race_cat == 2 & hispanic == 0 ~ 2,
                                race_cat == 3 & hispanic == 0 ~ 3, 
                                race_cat == 4 & hispanic == 0 ~ 4,
                                race_cat %in% c(0:4) & hispanic==1 ~5)) %>%
  
        mutate(any_dead = case_when(Vitalstatusrecodestudycutoffuse == 0 ~1,
                                Vitalstatusrecodestudycutoffuse == 1 ~0)) %>%
  
        mutate(can_dead = case_when(SEERcausespecificdeathclassific == 0 ~0,
                                SEERcausespecificdeathclassific == 1 ~1))

seer0to39$age_cat<-factor(seer0to39$age_cat, levels=c(0:4), labels=c("0-4", "5-9", "10-14", "15-19", "20-39"))
seer0to39$race_cat<-factor(seer0to39$race_cat, levels=c(0:4), labels=c("White", "Black", "AIAN", "API", "Unknown"))
seer0to39$hispanic<-factor(seer0to39$hispanic, levels=c(0:1), labels=c("Non-Hispanic", "Hispanic"))
seer0to39$race_ethnicity<-factor(seer0to39$race_ethnicity, levels=c(0:5), labels=c("Non-Hispanic White", "Non-Hispanic Black", "Non-Hispanic AIAN", "Non-Hispanic API", "Non-Hispanic Unknown", "Hispanic")) 
seer0to39$any_dead<-factor(seer0to39$any_dead, levels=c(0:1), labels=c("Alive", "Dead"))

table(seer0to39$age_cat)
table(seer0to39$race_cat)
table(seer0to39$hispanic)
table(seer0to39$race_ethnicity)
table(seer0to39$any_dead)
table(seer0to39$can_dead)

# calculate survival time from month of dx, recode year of dx, Month_of_last_follow_up_recode, Year_of_last_follow_up_recode. The difference between these variable dates would provide months of follow-up

# SEERothercauseofdeathclassifica
summary(seer0to39$Month_of_diagnosis_recode)
summary(seer0to39$Year_of_diagnosis)
summary(as.numeric(seer0to39$Month_of_last_follow_up_recode))
seer0to39$Month_of_last_follow_up_recode<-as.numeric(seer0to39$Month_of_last_follow_up_recode)
summary(seer0to39$Month_of_last_follow_up_recode)
summary(seer0to39$Year_of_last_follow_up_recode)

# assign a date of diagnosis using 15 as the day
seer0to39$proxy_day_of_dx <-15
seer0to39$proxy_day_of_fu <-15

seer0to39<-seer0to39 %>%
  mutate(proxy_dx_date = make_date(Year_of_diagnosis, Month_of_diagnosis_recode, proxy_day_of_dx)) %>%
  mutate(proxy_fu_date = make_date(Year_of_last_follow_up_recode, Month_of_last_follow_up_recode, proxy_day_of_fu))

# calculate the difference in days between the estimated date of dx and estimated date of last follow-up
seer0to39$survday<-as.numeric(difftime(seer0to39$proxy_fu_date, seer0to39$proxy_dx_date, units=c("days")))
summary(seer0to39$survday)

# estimate survival months by dividing by the average number of days in a month
seer0to39$survmo<-seer0to39$survday/30.437

summary(seer0to39$survmo)
class(seer0to39$survmo)
class(seer0to39$any_dead)

# cancer type coding
table(seer0to39$ICCCsiterecode_ICD_O_3_WHO_2008)

class(seer0to39$ICCCsiterecode_ICD_O_3_WHO_2008)

seer0to39<-seer0to39 %>%
  mutate(can_type = case_when(
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(11, 12,13,14,15)~0,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(21,22,23,24,25)~1,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(31,32,33,34,35,36)~2,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(41,42) ~3,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(50) ~4,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(62,62,63) ~5,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(71,72,75) ~6,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(81,82, 83,84,85) ~7,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(91,92,93,94,95)~8,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(101,102,103, 104,105) ~9,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(111,112,113,114,115,116) ~10,
    ICCCsiterecode_ICD_O_3_WHO_2008 %in% c(121)~11))

seer0to39$can_type<-factor(seer0to39$can_type, levels=c(0:11), labels=c(
  "I. Leukemias, myeloproliferative diseases, and myelodysplastic diseases",
  "II. Lymphomas and reticuloendothelial neoplasms",
  "III. CNS and miscellaneous intracranial and intraspinal neoplasms",
  "IV. Neuroblastoma and other peripheral nervous cell tumors",
  "V. Retinoblastoma",
  "VI. Renal tumors",
  "VII. Hepatic tumors",
  "VIII. Malignant bone tumors",
  "IX. Soft tissue and other extraosseous sarcomas",
  "X. Germ cell tumors, trophoblastic tumors, and neoplasms of gonads",
  "XI. Other malignant epithelial neoplasms and malignant melanomas",
  "XII. Other and unspecified malignant neoplasms"))
    
table(seer0to39$can_type)  
```
# Exclusions
```{r}
seer0to39 <- seer0to39 %>%
  filter(Firstmalignantprimary_indicator == 1)
```

# eligibility data management by year
definitions from Bradley et al, Cancer
1. not insured by Medicaid--does not link
2. insured by Medicaid within the 12 months before dx
3. insured by Medicaid only in the month of the dx or within the 12 months after the dx
4. insured both before and after dx categorized as insured before dx


# Exclude those with missing data on variables used in the analysis
```{r}
seer0to39<-seer0to39 %>%
  filter(!is.na(survmo), !is.na(can_dead), !is.na(In_Medicaid_Flag), !is.na(race_cat), !is.na(age_cat), !is.na(Census_Tract_Poverty_Indicator))


# exclude multiple state medicaid ids within a single year
seer0to39 <- seer0to39 %>% 
  filter(!patient_id %in% x)
```

# Merge in Derek's variable for number of months pre and post indicator within 3 month windows
```{r}
# select variables needed from mcseer
mcseer2 <- mcseer %>%
  select(patient_id, status, status3, pre_mo3, post_mo3, status6, pre_mo6, post_mo6, status12, pre_mo12, post_mo12)

seer0to39<-left_join(seer0to39, mcseer2, by = c("patient_id"))
```


# Another strategy
- Use Derek's status 3 variable that is coded as follows:
* 0 = not enrolled in Medicaid in DX month
* 1 = enrolled in Medicaid in DX month
* 2 = not enrolled in Medicaid in DX month, BUT was enrolled at least 1 of the 3 mos PRIOR
* 3 = not enrolled in Medicaid in DX month, BUT was enrolled at least 1 of the 3 mos AFTER
* 9 = missing Medicaid enrollment status in DX month (assume not enrolled?)

- for those coded as 9 use the following annotation:
- use In_Medicaid_Flag = 1 and coding used for In_Medicaid_Flag = 0

# another simpler one
```{r}
seer0to39 <- seer0to39 %>%
  # NEVER ENROLEES
  mutate(enroll3_cat3 = if_else(In_Medicaid_Flag == 0 & Primary_Payer_at_DX %in% c(20,21), 0, # not enrolled in Medicaid/enrolled in private
                        if_else(In_Medicaid_Flag == 0 & Primary_Payer_at_DX %in% c(31,35,60,61,62,63,64,65,66,67,68, 99,10), 1, # all other non-medicaid categories
                        if_else(In_Medicaid_Flag == 0 & Primary_Payer_at_DX %in% c(1,2), 2, # uninsured
                        
                                
  # ENROLLEES
                        if_else(In_Medicaid_Flag == 1 & status == 0, 3, # not enrolled in Medicaid in dx month
                        if_else(In_Medicaid_Flag == 1 & status3 == 1 & (pre_mo3 >0 & post_mo3 >0), 4, # continuous enrollment through dx month
                        if_else(In_Medicaid_Flag == 1 & status3 %in% c(0,1,2,3,4), 3, # discontinuous enrollment
                        if_else(In_Medicaid_Flag == 1 & status3 == 9 & Primary_Payer_at_DX %in% c(20,21), 5, #  missing Medicaid enrollment status in DX month/private
                        if_else(In_Medicaid_Flag == 1 & status3 == 9 & Primary_Payer_at_DX %in%  c(31,35,60,61,62,63,64,65,66,67,68, 99,10), 6,#  missing Medicaid enrollment status in DX month/other categories
                        if_else(In_Medicaid_Flag == 1 & status3 == 9 & Primary_Payer_at_DX %in% c(1,2),  7, NULL)))))))))) # missing Medicaid enrollment status in DX month/uninsured

# code NAs who are enrolled in Medicaid with Medicaid (need to fix this later)
seer0to39 <- seer0to39 %>%
  # NEVER ENROLEES
  mutate(enroll3_cat3 = if_else(In_Medicaid_Flag == 1 & is.na(enroll3_cat3), 5, enroll3_cat3))

seer0to39$enroll3_cat3 <- factor(seer0to39$enroll3_cat3, levels = c(0:7), labels = 
                                   c("0:NM Private", 
                                     "1: NM Other", 
                                     "2: NM Uninsured",
                                     "3: ME or NME in dx month discontinuous", 
                                     "4: ME continuous",
                                     "5: MME in dx month/private",
                                     "6: MME in dx month/other",
                                     "7: MME in dx month/uninsured"
                                     ))

test <- seer0to39 %>%
  group_by(In_Medicaid_Flag, insurance, status3, pre_mo3, post_mo3) %>%
  count(enroll3_cat3)

table(seer0to39$enroll3_cat3, seer0to39$insurance, useNA = "always")
```


# make separate dataframes for 0 to 19 and 20 to 39
```{r}
# make separate dataframes for 0 to 19 and 15 to 39
seer0to19 <- seer0to39 %>%
  filter(age_cat %in% c("0-4", "5-9", "10-14", "15-19"))

seer20to39 <- seer0to39 %>%
  filter(age_cat %in% c("20-39"))
```

# Survival plots (# In_Medicaid_flag)
```{r}
# In_Medicaid_flag

table(seer0to19$insurance)
p<-survival<- ggsurvplot(fit = survfit(Surv(survmo, can_dead) ~ In_Medicaid_Flag, seer0to19), 
    xlab = "Months from diagnosis", 
    ylab = "Cancer survival proportion",
    legend.title = "Insurance",
    font.legend=c(10, "bold"),
    legend.labs = c("Medicaid not linked", "Medicaid linked"),
    palette=c("black", "blue", "gray", "red"),
    font.x = c(18, "bold"),
    font.y = c(18, "bold"),
    xlim=c(0, 60),
    ylim=c(0, 1),
    censor.size=0.5,
    font.tickslab = c(16, "bold"),
    pval=TRUE)

p 

p$plot + scale_x_continuous(breaks = c(0,12,24,36,48,60))

ggsave(filename = "KMcurveplot0to19.png",
       width = 11, height = 8.5, units = "in", bg="white") 

# 20 to 39
p1<-survival<- ggsurvplot(fit = survfit(Surv(survmo, can_dead) ~ In_Medicaid_Flag, seer20to39), 
    xlab = "Months from diagnosis", 
    ylab = "Cancer survival proportion",
    legend.title = "Insurance",
    font.legend=c(10, "bold"),
    legend.labs = c("Medicaid not linked", "Medicaid linked"),
    palette=c("black", "blue", "gray", "red"),
    font.x = c(18, "bold"),
    font.y = c(18, "bold"),
    xlim=c(0, 60),
    ylim=c(0, 1),
    censor.size=0.5,
    font.tickslab = c(16, "bold"),
    pval=TRUE)

p1

p1$plot + scale_x_continuous(breaks = c(0,12,24,36,48,60))

ggsave(filename = "KMcurveplot20to39.png",
       width = 11, height = 8.5, units = "in", bg="white") 

# estimate survival time 0 to 19
x<-summary(survfit(Surv(survmo, can_dead) ~ In_Medicaid_Flag, data = seer0to19), times = 60)
x

# estimate survival time 20 to 39
y<-summary(survfit(Surv(survmo, can_dead) ~ In_Medicaid_Flag, data = seer20to39), times = 60)
y
```

# Survival plots by cancer type (Private and Medicaid)
```{r}
# make function for KM curves for age groups and tumor type
KMplots<-function(tumortype, figtitle){
  x<-seer0to19%>%
    filter(can_type == tumortype, insurance %in% c("Private Insurance", "Medicaid"))
  survob <- survfit(
    Surv(survmo, can_dead) ~ In_Medicaid_Flag, data = x)
ggsurvplot(survob, data=x, xlim = c(0,60),  
           pval=TRUE, ylim=c(50,100), fun="pct", 
           size=0.3, 
           conf.int=FALSE, 
           censor=TRUE,  
           title=figtitle,  
           size = 1, 
           censor.size=0.1,
           xlab="Survival time (months)", 
           linetype = 1,
           legend.title="",
           legend.labs = c("Private Insurance", "Medicaid"), palette = c("black", "blue"), break.x.by = 12) +
theme_survminer(font.main = c(20, "bold", "black"), legend=c("bottom"), font.legend=c(20, "bold", "black"), font.y=c(15, "bold"), font.x=c(15, "bold")) 
}

A<-KMplots("I. Leukemias, myeloproliferative diseases, and myelodysplastic diseases",  "A. Leukemias, myeloproliferative  diseases, \n and myelodysplastic diseases")
A
B<-KMplots("II. Lymphomas and reticuloendothelial neoplasms",  "b. II. Lymphomas and reticuloendothelial neoplasms")
B
C<-KMplots("III. CNS and miscellaneous intracranial and intraspinal neoplasms",  "B. CNS and miscellaneous intracranial \n and intraspinal neoplasms")
C
D<-KMplots("IV. Neuroblastoma and other peripheral nervous cell tumors",  "d. IV. Neuroblastoma and other peripheral nervous cell tumors")
D
E <- KMplots("V. Retinoblastoma",  "e. V. Retinoblastoma")
E
F <- KMplots("VI. Renal tumors",  "f. VI. Renal tumors")
F
G <- KMplots("VII. Hepatic tumors",  "g. VII. Hepatic tumors")
G
H <- KMplots("VIII. Malignant bone tumors",  "h. VIII. Malignant bone tumors")
H
I <- KMplots("IX. Soft tissue and other extraosseous sarcomas",  "i. IX. Soft tissue and other extraosseous sarcomas")
I
J <- KMplots("X. Germ cell tumors, trophoblastic tumors, and neoplasms of gonads",  "j. X. Germ cell tumors, trophoblastic tumors, and neoplasms of gonads")
J
K <- KMplots("XI. Other malignant epithelial neoplasms and malignant melanomas",  "k. XI. Other malignant epithelial neoplasms and malignant melanomas")
L <- KMplots("XII. Other and unspecified malignant neoplasms",  "l. XII. Other and unspecified malignant neoplasms")
L

library(patchwork)
pdf("Figure.pdf", width=11, height=10, paper="USr")
A$plot + B$plot + C$plot+ D$plot+ E$plot +F$plot +G$plot +H$plot +I$plot+ J$plot + K$plot + L$plot + plot_layout(ncol=4, nrow=3, guides='collect') &
  theme(legend.position='bottom')
dev.off()

# just leukemia and CNS tumors
pdf("Figure_leukemia_CNS.pdf", width=8.5, height=11, paper="USr")
A$plot + C$plot+ plot_layout(ncol=1, nrow=2, guides='collect') &  theme(legend.position='bottom')
dev.off()

```


# Survival plot by Derek's 3 month window variables
```{r}
p<-ggsurvplot(fit = survfit(Surv(survmo, can_dead) ~ enroll3_cat3, data =seer0to19), 
    xlab = "Months from diagnosis", 
    ylab = "Cancer survival proportion",
    legend.title = "",
    #legend.labs = c("Not enrolled  \n in Medicaid/private at dx", "Not enrolled  \n in Medicaid/other", "Not enrolled \n Uninsured", "Enrolled in the 3 month \n window before and after", "Not enrolled in either the 3 month \n window before or after", "Enrolled in the 3 month \n window after but not before", "Enrolled in the 3 month \n window before but not after"),
    font.legend=c(8, "bold"),
    legend = c("right"),
    palette=c("black", "maroon2", "cyan3", "red", "orange", "green", "purple", "yellow"),
    font.x = c(18, "bold"),
    font.y = c(18, "bold"),
    #xlim=c(0, 60),
    ylim=c(0, 1),
    censor.size=0.5,
    font.tickslab = c(16, "bold"),
    pval=TRUE,
    risk.table = FALSE,
    risk.table.fontsize=3,
    tables.height = 0.2,
    tables.theme = theme_cleantable())
p


ggsave(filename = "Enroll3_cat2 KM plot 0 to 19.png",
       width = 11, height = 8.5, units = "in", bg="white") 

table(seer0to19$enroll3_cat2, seer0to19$can_dead, useNA = "always")

p1<-ggsurvplot(fit = survfit(Surv(survmo, can_dead) ~ enroll3_cat3, data =seer20to39), 
    xlab = "Months from diagnosis", 
    ylab = "Cancer survival proportion",
    legend.title = "",
    #legend.labs = c("Not enrolled  \n in Medicaid/private at dx", "Not enrolled  \n in Medicaid/other", "Not enrolled \n Uninsured", "Enrolled in the 3 month \n window before and after", "Not enrolled in either the 3 month \n window before or after", "Enrolled in the 3 month \n window after but not before", "Enrolled in the 3 month \n window before but not after"),
    font.legend=c(8, "bold"),
    legend = c("right"),
    palette=c("black", "maroon2", "cyan3", "red", "orange", "green", "purple", "yellow"),
    font.x = c(18, "bold"),
    font.y = c(18, "bold"),
    #xlim=c(0, 60),
    ylim=c(0, 1),
    censor.size=0.5,
    font.tickslab = c(16, "bold"),
    pval=TRUE,
    risk.table = FALSE,
    risk.table.fontsize=3,
    tables.height = 0.2,
    tables.theme = theme_cleantable())
p1

ggsave(filename = "Enroll_cat6 KM plot 20 to 39.png",
       width = 11, height = 8.5, units = "in", bg="white") 

table(seer0to19$enroll3_cat, seer0to19$Primary_Payer_at_DX)
```



# Cox proportional hazards models
```{r}
# 0 TO 19
res.cox <- coxph(Surv(survmo, can_dead) ~ In_Medicaid_Flag, data = seer0to19) # Univariable model
res.cox
summary(res.cox)

# 20 TO 39
res.cox <- coxph(Surv(survmo, can_dead) ~ In_Medicaid_Flag, data = seer20to39) # Univariable model
res.cox
summary(res.cox)

# adjusted models
res.cox <- coxph(Surv(survmo, can_dead) ~ In_Medicaid_Flag +race_cat +age_cat + Census_Tract_Poverty_Indicator, data = seer0to19) # Model adjusted for race age and a measure of poverty
res.cox
summary(res.cox)

# adjusted model for leukemia and CNS tumors
leuk <-seer0to19 %>%
  filter(can_type == "I. Leukemias, myeloproliferative diseases, and myelodysplastic diseases", insurance %in% c("Private Insurance", "Medicaid"))
  
leuk.cox <- coxph(Surv(survmo, can_dead) ~ insurance +race_cat +age_cat + Census_Tract_Poverty_Indicator, data = leuk) # Model adjusted for race age and a measure of poverty
leuk.cox
summary(leuk.cox)

brain <-seer0to19 %>%
  filter(can_type == "III. CNS and miscellaneous intracranial and intraspinal neoplasms", insurance %in% c("Private Insurance", "Medicaid"))

brain.cox <- coxph(Surv(survmo, can_dead) ~ insurance +race_cat +age_cat + Census_Tract_Poverty_Indicator, data = brain) # Model adjusted for race age and a measure of poverty
brain.cox
summary(brain.cox)

# Interactions
# race_cat
res.cox2 <- coxph(Surv(survmo, can_dead) ~ In_Medicaid_Flag +race_cat +age_cat + Census_Tract_Poverty_Indicator + race_cat*In_Medicaid_Flag, data = seer0to19) # Model adjusted for race age and a measure of poverty
res.cox2
summary(res.cox2)

# census tract poverty indicator
res.cox3 <- coxph(Surv(survmo, can_dead) ~ In_Medicaid_Flag +race_cat +age_cat + Census_Tract_Poverty_Indicator + Census_Tract_Poverty_Indicator*In_Medicaid_Flag, data = seer0to19) # Model adjusted for race age and a measure of poverty
res.cox3
summary(res.cox3)
```

# Overall for San Antonio conference
```{r}
# census tract poverty indicator
res.cox4 <- coxph(Surv(survmo, can_dead) ~ timing +race_cat +age_cat + Census_Tract_Poverty_Indicator, data = dfp) # Model adjusted for race age and a measure of poverty
res.cox4
summary(res.cox4)
```

```{r}
# limit to 0 to 14 to qualitatively compare with Lee et al
seer0to14 <- seer0to19 %>%
  filter(Agerecodewithsingleages_and_100<15)

res.cox <- coxph(Surv(survmo, can_dead) ~ In_Medicaid_Flag +race_cat +age_cat + Census_Tract_Poverty_Indicator + as.factor(SEER_historic_stage_A_1973_2015), data = seer0to14) # Model adjusted for race age and a measure of poverty
res.cox
summary(res.cox)

colnames(seer0to19)

# look at stage at dx as an outcome

table(seer0to14$SEER_historic_stage_A_1973_2015, useNA="always")

seer0to14 <-seer0to14 %>%
  mutate(stage_cat = case_when(SEER_historic_stage_A_1973_2015 %in% c(0,1) ~0,
                               SEER_historic_stage_A_1973_2015 %in% c(2,4) ~1))

table(seer0to14$stage_cat, useNA="always")

log <- glm (stage_cat ~ In_Medicaid_Flag + race_cat +age_cat + Census_Tract_Poverty_Indicator, data=seer0to14, family = "binomial")

summary(log)
library(odds.n.ends)
odds.n.ends(log)
```

# Conduct analyses using the 3 month variable
```{r}
res.cox <- coxph(Surv(survmo, can_dead) ~ enroll_cat +race_cat +age_cat + Census_Tract_Poverty_Indicator, data = seer0to19) # Model adjusted for race age and a measure of poverty
res.cox
summary(res.cox)

# what is time to event in those enrolled Not enrolled in 3 month window before but not after?

three_before <- seer0to19 %>%
  group_by(enroll_cat, can_dead) %>%
  summarise(med = median(survmo), mean = mean(survmo), n = n())

table(three_before$can_dead)
```

